@using web_payrolls.Helpers
@using web_payrolls.Models
@{
  ViewBag.Title = "Transfer Balance";
}

@{
  // connection
  var db = new DB_Connection();
  var provider = new ContextProvider(new ClHelper(), new DB_Connection());

  // hod
  var hod = db
    .tblBosses
    .Select(boss => new SelectListItem()
    {
      Value = boss.PK_Boss_Id + "",
      Text = boss.Name,
      Selected = boss.PK_Boss_Id == provider.ManagerId
    })
    .ToList();

  // company
  var company = db
    .tblCompanies
    .Select(com => new SelectListItem()
    {
      Value = com.PK_Comp_Id + "",
      Text = com.Comp_Name,
      Selected = com.PK_Comp_Id == provider.CompanyId
    })
    .ToList();

  // location
  var location = db
    .tblLocations
    .Select(x => new SelectListItem()
    {
      Value = x.PK_Location_Id + "",
      Text = x.Loc_Name,
      Selected = x.PK_Location_Id == provider.LocationId
    })
    .ToList();
}

<style>
  .table td, .table th {
      border-color: #ced4da;
  }

  .custom-select-form {
      padding: 2px;
      border: #dddddd 1px solid;
  }
</style>

@* Card Filter *@
<div class="card" style="margin-bottom: 0;border-top: #428bca 3px solid">
  <div class="card-header">
    <div class="card-actions">
      <a class="" data-action="collapse">
        <i class="ti-minus"></i> @Resources.Voucher.Show / @Resources.Voucher.Hide
      </a>
    </div>
    <h4 class="card-title m-b-0 card-text">
      <i class="ti-filter"></i> @Resources.Voucher.Filter
    </h4>
  </div>
  <div class="card-body collapse show b-t">
    <form method="get" action="@Url.Action("TransferBalance", "Transfer")" id="form-search">
      <div class="row">

        @Html.Partial("~/Views/Components/Controls/HOD.cshtml")


        <div class="form-group col-xlg-3 col-md-4">
          <label>Company</label>
          <div class="input-group">
            @Html.DropDownList("company", company, "-- Choose Company --", new {@class = "form-control"})
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4">
          <label>Location</label>
          <div class="input-group">
            @Html.DropDownList("location", location, "-- Choose Location --", new {@class = "form-control"})
          </div>
        </div>


        <div class="form-group col-xlg-3 col-md-4">
          <label for="type">Product Type</label>
          <div class="input-group">
            <select id="type" name="type" class="form-control">
              <option value="">-- Choose Product Type --</option>
              <option value="Processing">Processing</option>
            </select>
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="type_name">Type Name</label>
          <div class="input-group">
            <select id="type_name" name="type_name" class="form-control">
              <option value="">-- @Resources.Voucher.Choose Type Name --</option>
            </select>
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="product_name">Product Name</label>
          <div class="input-group">
            <select id="product_name" name="product_name" class="form-control">
              <option value="">-- @Resources.Voucher.Choose Product Name --</option>
            </select>
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="color">Color</label>
          <div class="input-group">
            <select id="color" name="color" class="form-control">
              <option value="">-- @Resources.Voucher.Choose Color --</option>
            </select>
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="size">Size</label>
          <div class="input-group">
            <select id="size" name="size" class="form-control">
              <option value="">-- @Resources.Voucher.Choose Size --</option>
            </select>
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="grade">Grade</label>
          <div class="input-group">
            <select id="grade" name="grade" class="form-control">
              <option value="">-- @Resources.Voucher.Choose Grade --</option>
            </select>
          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="barcode">Barcode</label>
          <div class="input-group">
            <input class="form-control" id="barcode" name="barcode" placeholder="Search barcode" autocomplete="off"/>
            <div class="input-group-append">
              <span class="input-group-text">
                <i class="ti-layout-column4"></i>
              </span>
            </div>

          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="qrCode">Qr Code</label>
          <div class="input-group">
            <input class="form-control" id="qrCode" name="qrCode" placeholder="Search Qr code" autocomplete="off"/>
            <div class="input-group-append">
              <span class="input-group-text">
                <i class="ti-layout-grid4"></i>
              </span>
            </div>

          </div>
        </div>

        <div class="form-group col-xlg-3 col-md-4 ">
          <label for="status">Status</label>
          <div class="input-group">
            <select id="status" name="status" class="form-control">
              <option value="">-- Choose Status --</option>
              <option value="Enable">Enable</option>
              <option value="Disable">Disable</option>
            </select>
          </div>
        </div>

        <input type="hidden" id="pageSize" name="pageSize" value="20"/>

      </div>
      <button class="btn btn-info btn-sm"><i class="ti-search"></i> Searching</button>
    </form>
  </div>

</div>
@* Card Filter *@


<div id="show"></div>

@section Scripts
{
  <script>
    let token = { __RequestVerificationToken : $('input[name="__RequestVerificationToken"]').val()};

    let searchParams = new URLSearchParams(window.location.search);

    function getFormData($form){
        let unindexed_array = $form.serializeArray();
        let indexed_array = {};

        $.map(unindexed_array, function(n, i){
            indexed_array[n['name']] = n['value'];
        });

        return indexed_array;
    }

    let $form = $("#form-search");
    let data = getFormData($form);
    $('#show').load('/Transfer/GetTableBalance',{
        ...data
    });

    function setParams(ctn){
      if(searchParams.has(ctn)){
         $('#'+ctn).val(searchParams.get(ctn));
      }
    }
     // select 2
     function Select2(ctn){
        $(ctn).select2({ width: '100%', placeholder: "Select an Option", allowClear: true });
     }

    Select2('#bid');
    Select2('#grade');
    Select2('#size');
    Select2('#status');
    Select2('#color');
    Select2('#product_name');
    Select2('#type_name');
    Select2('#type');
    Select2('#location');
    Select2('#company');

    setParams('barcode');
    setParams('qrCode');
    setParams('status');
    setParams('grade');
    setParams('size');
    setParams('color');
    setParams('product_name');
    setParams('type_name');
    setParams('type');
    setParams('company');
    setParams('location');
    setParams('bid');
    setParams('pageSize');

     // Export
    $(document).on('click', '#btn-export', function () {
        $('#table-transfer-balance').csvExport();
    });


    $('#pageSize_').val(searchParams.get('pageSize') ? searchParams.get('pageSize') : 20);

    $(document).on('click','#pagination ul li a',function(e) {
      e.preventDefault();
      alert("Home");
      let page = $(this).attr('href').split('=')[1];

      let form = $('#form-search').serialize();
      console.log(form);
     // location.href = '/Transfer/TransferBalance?page='+ page + '&' + form;
    });

    $(document).on('change','#pageSize_',function(e) {
       e.preventDefault();
       let pageSize = $(this).val();

       $('#pageSize').val(pageSize);

       $('#form-search').submit();
    });


       // sweet alert
       function SweatAlert(message, type) {
            swal({
                title: message,
                type: type,
                timer: 1500
            });
       }

       // Filter

       // get data from api
        function GetDataApi(url, data) {
           let dataResponse = null;
           let error = false;
           $.ajax({
             url: url,
             async: false,
             type: "POST",
             global: false,
             dataType: 'json',
             data: data,
             success: function(response) {
                dataResponse = response
             },
             error: function() {
               error =  true
             }
           });
           return {data: dataResponse, error};
       }

       // get select option
       function setToSelect({data : data, label : label}) {
             let option = '<option value="">-- ' + 'Choose ' +  label + ' --</option>';
             for(let item in data){
                 option += '<option value="'+data[item].key+'">' + data[item].value + '</option>';
             }
             return option;
       }

       // bid
      $('#bid').change(function (){
          $('select#company').val(0).select2();
          $('select#type').val(0).select2();
          $('select#type_name').val(0).select2();
          $('select#product_name').val(0).select2();
          $('select#color').val(0).select2();
          $('select#size').val(0).select2();
          $('select#grade').val(0).select2();

          let dataForSent = {
              id: $(this).val(),
              ...token
          };

          let {data} = GetDataApi('/Other/GetCompany',dataForSent);

          $('#company').html(setToSelect({data: data, label: '@Resources.Voucher.Company'}));

          //$('#form-search').submit();
      });

        // cid
        $('#company').change(function (){
            $('select#type').val(0).select2();
             $('select#type_name').val(0).select2();
             $('select#product_name').val(0).select2();
             $('select#color').val(0).select2();
             $('select#size').val(0).select2();
             $('select#grade').val(0).select2();

            let dataForSent = {
                id: $(this).val(),
                ...token
            };

            let {data} = GetDataApi('/Other/GetLocation',dataForSent);

            $('#location').html(setToSelect({data: data, label: '@Resources.Voucher.Location'}));

        });

        // product type
           $('#type').change(function (){
              $('select#type_name').val(0).select2();
               $('select#product_name').val(0).select2();
               $('select#color').val(0).select2();
               $('select#size').val(0).select2();
               $('select#grade').val(0).select2();

               let dataForSent = {
                   bossId : $('#bid').val(),
                   productType: $(this).val(),
                   ...token
               };

               let {data} = GetDataApi('/StockInProductCut/GetProductTypeByBoss', dataForSent);

               $('#type_name').html(setToSelect({data: data, label: 'Type Name'}));
           });


           //type name
            $('#type_name').change(function (){


                 $('select#product_name').val(0).select2();
                  $('select#color').val(0).select2();
                  $('select#size').val(0).select2();
                  $('select#grade').val(0).select2();

                let dataForSent = {
                   id: $(this).val(),
                   ...token
                };

                let {data} = GetDataApi('/Other/GetProductByProductType', dataForSent);

                $('#product_name').html(setToSelect({data: data, label : "Product"}));

            });

            // product name
            $('#product_name').change(function (){

               $('select#color').val(0).select2();
               $('select#size').val(0).select2();
               $('select#grade').val(0).select2();

                let dataForSent = {
                    id: $(this).val(),
                    ...token
                };

                let {data} = GetDataApi('/Other/GetProductGradeByProductId',dataForSent);
                //
                let {colors, sizes, grades} = data;
                // set color
                $('#color').html(setToSelect({data: colors, label : "Color"}));
                // set size
                $('#size').html(setToSelect({data: sizes, label : "Size"}));
                // set grade
                $('#grade').html(setToSelect({data: grades, label : "Grade"}));

            });

            // color
            $('#color').change(function (){
                $('select#size').val(0).select2();
                $('select#grade').val(0).select2();
            });

            // size
            $('#size').change(function (){
                $('select#grade').val(0).select2();
            });

  </script>
}
